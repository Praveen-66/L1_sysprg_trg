/*
 * thrd4.c
 * using pthreads
 * show multithreading..
*/
#define _POSIX_C_SOURCE    200112L	/* or earlier: 199506L */

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <pthread.h>

#define LAST_COL	79

void *thrd_p2(void *);
void *thrd_p3(void *);

int main(int argc, char **argv)
{
	pthread_t p2, p3;
	int r;
	void *ret;

	if (argc < 2) {
		fprintf(stderr, "Usage: %s [count]\n", argv[0]);
		exit(1);
	}
	// now argv[1] holds the number of times each thread p2 & p3 
	// will write 2 and 3 respectively..

	printf("p1 (the main() thread):\n");

	// Create 2 threads (main p1 is parent..)
	printf("p1 (the main() thread): now creating pthread p2..\n\
		thread p2 will write 2 to stderr..\n");
	fflush(stdout);

	r = pthread_create(&p2,	// thread id
			   NULL,	// thread attributes (use default)
			   thrd_p2,	// function to execute
			   (void *)argv[1]);	// argument to function
	if (r)
		perror("pthread creation"), exit(1);

	printf("p1 (the main() thread): now creating pthread p3..\n\
		thread p3 will write 3 to stderr..\n");
	fflush(stdout);

	r = pthread_create(&p3,	// thread id
			   NULL,	// thread attributes (use default)
			   thrd_p3,	// function to execute
			   (void *)argv[1]);	// argument to function
	if (r)
		perror("pthread creation"), exit(1);

	printf
	    ("p1: threads p2 and p3 created..; now main thread p1 waiting on join..\n");
	fflush(stdout);
	if (pthread_join(p2, &ret) != 0)
		perror("pthread join"), exit(1);
	printf("p1: p2 has joined up\n");

	if (pthread_join(p3, &ret) != 0)
		perror("pthread join"), exit(1);
	printf("p1: p3 has joined up\n");

	exit(0);
}

// Thread p2
// write() 's "2" to stderr
void *thrd_p2(void *msg)
{
	int i;
	char buf[] = "2";
	char cr[] = "\n";

	for (i = 0; i < atoi((char *)msg); i++) {
		write(STDERR_FILENO, buf, 1);
		if ((i % LAST_COL) == 0)
			write(STDERR_FILENO, cr, 1);
	}

	pthread_exit(NULL);
}

// Thread p3
// write() 's "3" to stderr
void *thrd_p3(void *msg)
{
	int i;
	char buf[] = "3";
	char cr[] = "\n";

	for (i = 0; i < atoi((char *)msg); i++) {
		write(STDERR_FILENO, buf, 1);
		if ((i % LAST_COL) == 0)
			write(STDERR_FILENO, cr, 1);
	}

	pthread_exit(NULL);
}

/* Output:
$ cc -Wall thrd4.c -o thrd4 -lpthread
$
$ thrd4 3000 >rep 2>&1
$ 
$ cat rep
p1 (the main() thread):
p1 (the main() thread): now creating pthread p2..
		thread p2 will write 2 to stderr..
p1 (the main() thread): now creating pthread p3..
		thread p3 will write 3 to stderr..
2
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222p1: threads p2 and p3 created..; now main thread p1 waiting on join..
3
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
333333333333333333222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2223333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333332222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222222
2222222222222222222222222222222222222222222222222222222222222222222222222222p1: p2 has joined up
p1: p3 has joined up
*/
